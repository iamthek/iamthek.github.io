<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <title>ISdotnet_One</title>
    <script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.0.js"></script>
    <script type="text/javascript" src="scripts/SuperMap.IS.Include.js">
    </script>
    <script type="text/javascript">
        //定义全局变量
        var MapControl1 = null;
        var scalebar=null;

    
        function onPageLoad() {
            var params = new Object();
            params.mapHandler = "./";
            params.mapName = "World";
            params.imageFormat = "png";
            params.fixedView = false;
            params.handlerSecurityFunction = creatSecurityStr;
            var levels=new Array();
            levels[0] = 1/ 500000000;
            levels[1] = 1 / 250000000;
            levels[2] = 1 / 100000000;  
            levels[3] = 1 / 50000000;  
            levels[4] = 1 / 25000000;  
            params.mapScales = levels;
            params.mapScale = 1 / 500000000;
            MapControl1 = new SuperMap.IS.MapControl($("mapDiv"), params);
            var scaleparam = new Object();
            scaleparam.ordinal = true; 
            scaleparam.position = 0; 
            scalebar = new SuperMap.IS.ScaleBarControl($("scaleDiv"), MapControl1, scaleparam);
           
            MapControl1.Init();
        }
        function onPageUnload() {
            MapControl1.Destroy();
            MapControl1 = null;
        }
        function creatSecurityStr()
        {
            var psw = document.getElementById("pswTxt").value;
            var str = "admin&" + psw;
            return str;
        }
        //以下是地图操作工具
        function ViewEntire() {
            MapControl1.ViewEntire();
        }

        function SetPanAction() {
            var panAction = new SuperMap.IS.PanAction();
           
         MapControl1.SetAction(panAction);
        }

        function QuickZoomIn() {
            MapControl1.Zoom(2);
        }

        function QuickZoomOut() {
            MapControl1.Zoom(0.5);
        }

        function SetZoomInAction() {
            var zoomInAction = new SuperMap.IS.ZoomInAction();
            MapControl1.SetAction(zoomInAction);
        }

        function SetZoomOutAction() {
            var zoomOutAction = new SuperMap.IS.ZoomOutAction();
            MapControl1.SetAction(zoomOutAction);
        }
        //以下是功能代码
      
        function getLayerInfo(index) {
            var layer = new SuperMap.IS.Layer();
            layer = MapControl1.layers[index];
            var str = "图层名称:" + layer.name + "<br/>";
            str += "图层类型:" + returnLayerType(layer.type) + "<br/>";
            str += "图层最大可见比例尺:" + layer.maxScale + "<br/>";
            str += "图层最小可见比例尺:" + layer.minScale + "<br/>";
            str += "图层对象是否可查询:" + layer.queryable + "<br/>";
            function returnLayerType(type) {
                switch (type) {
                    case 0: return "未定义"; break;
                    case 1: return "点图层"; break;
                    case 3: return "线图层"; break;
                    case 4: return "网络图层"; break;
                    case 5: return "面图层"; break;
                    case 7: return "文本图层"; break;
                    case 81: return "影像图层"; break;
                    case 82: return "Mrsid图层"; break;
                    case 83: return "Grid图层"; break;
                    case 84: return "DEM图层"; break;
                    case 85: return "ECW图层"; break;
                    case 86: return "WMS图层"; break;
                    case 87: return "WCS图层"; break;
                    case 149: return "CAD图层"; break;
                    default: break;
                }
            }
            document.getElementById("layerInfoDiv").innerHTML = str;
        }
        function customDrawMarkAction() {
            this.type = "DrawPointAction";
            //DrawPointAction  用于mapcontrol1.SetAction()
            var actionStarted = false;
            var _self = this;
            var id = 0;
            this.Init = function (mapControl) {
                this.mapControl = mapControl;
                if (_ygPos.browser == "ie") {//设定鼠标样式
                    mapControl.container.style.cursor = _scriptLocation + "../images/cur_PointQuery.cur";
                }
               else {
                    mapControl.workLayer.style.cursor = "url(images/cur_PointQuery.cur),auto";
                };
            };
            this.Destroy = function () {
                this.mapControl.CustomLayer.RemoveMark("DrawMark");
                this.mapControl = null;
            };
            //成员对象函数加分号

            this.OnClick = function (e) {
                while (this.mapControl.CustomLayer.GetGeometry("customPoint" + id)) {
                    id++;
                }
                var markParam = new SuperMap.IS.MarkParam()
                markParam.id = id;
                markParam.x = e.mapCoord.x;
                markParam.y = e.mapCoord.y;
                var htmlStr = "<img src=\"images/btn_50_off.gif\"/>";
                markParam.innerHtml = htmlStr;
                MapControl1.CustomLayer.AddMark(markParam);
                MapControl1.PanToMapCoord(e.mapCoord.x,e.mapCoord.y);
            };
            this.OnDblClick = function (e) {
            };
            this.OnMouseMove = function (e) {
            };
            this.OnMouseDown = function (e) {
            };
            this.OnMouseUp = function (e) {
            };
            this.OnContextMenu = function (e) {
            };
            this.GetJSON = function () {
                return _ActionToJSON(this.type, []);
            };
        };


        function addMark() {
            var addMarkAction = new customDrawMarkAction();
            MapControl1.SetAction(addMarkAction);
        }
        function clearMark() {
            MapControl1.CustomLayer.ClearMarks();
            SetPanAction();
        }
        function queryByPolygon() {
            var layerSelect = document.getElementById("layerSlc");
            var queryLayerName = layerSelect.options[layerSelect.selectedIndex].innerText;
            if (!queryLayerName) return;
            var polygonQueryAction = new SuperMap.IS.PolygonQueryAction([queryLayerName], "", "", onQueryComplete, errorShow, null);
            MapControl1.SetAction(polygonQueryAction);
        }


        function queryBySQL()
        {
            var sqlStr=document.getElementById("queryTxt").value;
            var queryParam=new SuperMap.IS.QueryParam();
            queryParam.queryAllLayer=false;
            var querylayer=new SuperMap.IS.QueryLayer();
            querylayer.layerName="World@world";
            querylayer.relQueryTableInfos=[new SuperMap.IS.RelQueryTableInfo()];
            querylayer.relQueryTableInfos[0].joinType =1;
            querylayer.relQueryTableInfos[0].searchCondition="ReTable.Rkey=World.SmID";
            querylayer.relQueryTableInfos[0].tableName="ReTable";
            querylayer.whereClause =sqlStr;
            queryParam.queryLayers=[querylayer];
        
            queryParam.returnCenterAndBounds=true;
            MapControl1.GetQueryManager().QueryBySql(queryParam,onQueryComplete,errorShow,null);

        }
        function onQueryComplete(resultSet) {
            if (!resultSet || resultSet.totalCount < 1) {
                alert("查询结果为空");
            }
            else{
                var answerStr = "查询结果如下：<br/>"; var center=new SuperMap.IS.MapCoord();
                for (var i = 0; i < resultSet.recordsets.length; i++) {
                    answerStr += "图层：" + resultSet.recordsets[i].layerName + "<br/>";
                    for (var j = 0; j < resultSet.recordsets[i].records.length; j++) {
                        var _record = resultSet.recordsets[i].records[j];//类型为record
                         center=_record.center;
                        answerStr += "----------------------<br/>";
                        for (var k = 0; k < _record.fieldValues.length; k++) {
                            var _attributeField = resultSet.recordsets[i].returnFields[k];
                            //属性字段列表 类型string
                            answerStr += _attributeField + ": " + _record.fieldValues[k] + "<br/>";
                        }

                    }
                }
                MapControl1.PanToMapCoord(center.x,center.y);
                document.getElementById("answerDIV").innerHTML = answerStr;
            }
        }
        function  errorShow(errorStr){
            alert(errorStr);
        }
        function clearAnswer()
        {
            MapControl1.ClearHighlight();
            answerDIV.innerHTML = "";
            layerInfoDiv.innerHTML = "";
        }
        function addTileLayer()
        {
             MapControl1.CustomLayer.AddTileLayer("MyTileWMSLayer", GetTileID, GetTileUrl, null, 0, 0, 0, 0.8, 11, 256, 256, null);
        }


function GetTileID (tx, ty, ms) {
    var level = MapControl1.GetZoomLevel();
    return "myTileLayer1_" + tx + "_" + ty + "_" + level;
}

function GetTileUrl (tx, ty, ms) {
    var tileBounds = MapControl1.GetTileBounds(tx, ty, 256, 256);
    var lb = tileBounds.leftBottom;
    var rt = tileBounds.rightTop;
    var level=MapControl1.GetZoomLevel ();
    var url= "WmtsHandler.ashx?tileBoundInfo=" + lb.x + "," + lb.y + "," + rt.x + "," + rt.y + "," + tx + "," + ty + "," + level;
    return url;
}
//清除TileLayer图层
 function ClearTileLayer() {
     var a = MapControl1.CustomLayer.RemoveTileLayer("MyTileWMSLayer");
 }
 function CreateLabelTheme(){
          var labelTheme = new SuperMap.IS.LabelTheme();
          labelTheme.enabled = true;          
          labelTheme.caption = "标签专题图";
          // 设置分类字段
          labelTheme.expression = "ＣＯＮＴＩＮＥＮｔ";
          
          labelTheme.display = new SuperMap.IS.TextStyle();
          labelTheme.display.color = ColorConvertor(113,113,113);
          labelTheme.display.bgColor = ColorConvertor(192,192,192);
          labelTheme.display.fixedSize = false;
          labelTheme.display.shadow = false;
          labelTheme.display.transparent = true;
          labelTheme.display.outline = true;
//      labelTheme.display.fixedTextSize = 111;
          labelTheme.display.fontName = "微软雅黑";
          labelTheme.display.fontHeight = 5;
          labelTheme.display.fontWidth = 3;
          labelTheme.offsetFixed = true;
          labelTheme.offsetXExpression = "-80";
          labelTheme.alongLine = true;
          labelTheme.enableFlow = false;
          labelTheme.filter = "SmArea > 2";
          labelTheme.textControlMode = SuperMap.IS.TextControlMode.wrapText;
          labelTheme.isTextExpression =true;
          var layer = GetLayer("World@world");
          if (layer == null)
          {
            alert("没有World@world图层！请先点击“切换地图”将地图切换至World地图！");
            return;
          }
          layer.themeLabel = labelTheme;
          // 需要更新 mapcontrol，重新获取地图
          MapControl1.Update();        
        
      }
   function ColorConvertor(r,g,b)
      {
          var color = new SuperMap.IS.Color();
          color.b = parseInt(b);
          color.g = parseInt(g);
          color.r = parseInt(r);
          var colorConvertor = new SuperMap.IS.Convertor();
          var colorInt = colorConvertor.SystemColorToIntegerColor(color);
          return colorInt;
      }
       function GetLayer(layerName){
         
         if (!MapControl1.layers || !MapControl1.layers.length) { return; }
         for (var i = 0; i < MapControl1.layers.length; i++) {
            // 选择对world@world图层做专题图
            if (MapControl1.layers[i].name == layerName) {
                var layer = new SuperMap.IS.Layer();
                layer = MapControl1.layers[i];
                break;
            }  
          }
          return layer;
      
      }
    </script>
    <style type="text/css">
        #leftBox {
            float: left;
            position: relative;
        }

        #rightBox {
            float: left;
            padding: 10px;
        }

        #midBox {
            float: left;
            padding: 10px;
        }

        #mapDiv {
            width: 660px;
            height: 500px;
            margin: 0;
            padding: 0;
            position: relative;
            left: 2px;
            top: 2px;
            border: solid 1px gray;
        }

        li:hover {
            color: blue;
        }
        #scaleDiv{
                position: absolute;
                left:30px;
                top: 30px;
                display:block;
                z-index: 100;
            }
    </style>
</head>
<body onunload="onPageUnload()" onload="onPageLoad()">
    <div id="leftBox">
        <div id="mapDiv">
        </div>
        <div id="scaleDiv"></div>
        <div id="tools">
            <table>
                <tr>
                    <td>
                        <img alt="全屏显示" title="全图" src="images/btn_01_off.gif" onclick="ViewEntire()" />
                        <img alt="地图漫游" title="移动" src="images/btn_06_off.gif" onclick="SetPanAction()" />
                        <img alt="快速放大" title="中心放大" src="images/btn_ZoomIn.gif" onclick="QuickZoomIn()" />
                        <img alt="快速缩小" title="中心缩小" src="images/btn_ZoomOut.gif" onclick="QuickZoomOut()" />
                        <img alt="拉框放大" title="拉框放大" src="images/btn_04_off.gif" onclick="SetZoomInAction()" />
                        <img alt="拉框缩小" title="拉框缩小" src="images/btn_05_off.gif" onclick="SetZoomOutAction()" />
                    </td>
                </tr>
                <tr>
                    <td>
                      <input type="button" value="叠加wmts" onclick="addTileLayer()"/>
                       <input type="button" value="移除wmts" onclick="ClearTileLayer()"/>
                       <input type="button" value="专题图" onclick="CreateLabelTheme()"/>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <div id="midBox">


    </div>
    <div id="rightBox">
    <strong>handler安全</strong><br/>扩展IHandlerSecurity接口，对QueryBySql方法进行控制<br/>
    需输入正确的密匙(admin)才能执行查询<br/>
        密匙<br />
        <input value="" type="password" id="pswTxt"/>
        <br />
        <input type="text" value="World.SmID = 5" id="queryTxt">
        <br />
		<input value="查询" onclick="queryBySQL()" type="button"/>
        <div id="answerDIV"></div>
    </div>
</body>
</html>
